<!DOCTYPE HTML>
<html ng-app="myApp">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src * data:; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
    <script src="components/loader.js"></script>
    <script type="text/javascript" src="javascripts/jquery.xdomainajax.js"></script>
    <script type="text/javascript" src="javascripts/dojoCommon.js"></script>
    <link rel="stylesheet" href="components/loader.css">
    <link rel="stylesheet" href="css/style.css">
    <script>
        var app = angular.module('myApp', ['onsen']);
        
        // what u want? -> toppage.htmlのinputに入力された値をpwdとしてurlに投げ、取得したページをpage1.htmlに出す
        app.value('pwds', {
          'login_pass' : {'pwd' : 2384},
          'username': 'crapcrap',
          'userpwd': 'thisistestid',
          });
          
        app.value('urls', {
          'index' : ['POST', 'https://library.rail-e.or.jp/e-library/Index'],
          'login' : ['GET', 'https://library.rail-e.or.jp/e-library/jsp/dojo/index.jsp']
        });
        
        app.factory('HTTPRequestService', ['$http', 'urls', '$httpParamSerializerJQLike', 
        function($http, urls, $httpParamSerializerJQLike){
          var httpRequestService = {};
          
          // @param add_key urls value key. add to urls ['REST', 'urls']
          httpRequestService.getHtml = function(add_key, datas, callback){
            // console.debug('request ' + urls[add_key][1]);
            $http({
              method : urls[add_key][0],
              headers : {
                'Content-Type' : 'application/x-www-form-urlencoded'
              },
              transformRequest : $httpParamSerializerJQLike,
              url : urls[add_key][1],
              data : datas
            }).then(function onSuccess(response){
              // console.log('success');
              callback(response.data);
            }, function onError(response){
              console.log('error : ' + urls[add_key][1]);
            });
          };
          
          return httpRequestService;
        }]);
        
        app.controller('PageController', ['$scope', 'pwds', 'urls', 'HTTPRequestService', 
          function($scope, pwds, urls, httpRequestService){
            $scope.pwd = pwds['login_pass']['pwd'];
            $scope.username = pwds['username'];
            $scope.userpwd = pwds['userpwd'];
            $scope.urls = urls;
            $scope.data = 'no name';
            
            $scope.firstLogin = function(){
              console.debug('go login.');
              $scope.isSpin = true;
              
              // Fail pattern.
              // httpRequestService.getHtml('index', {}, function(data){
              httpRequestService.getHtml('index', pwds['login_pass'], function(data){
                
                // Error Handring.
                if(data.match(/TopError/)){
                  console.log("Password missed");
                  alert('実力試験道場のパスワードが間違っています');
                  $scope.isSpin = false;
                  return;
                }
                
                httpRequestService.getHtml('login', {}, function(data){
                  // console.debug($(data).find('.footer').text());
                  var loginQuery = $(data);
                  
                  loginQuery.find('.login_input01 > #textPersonId').val($scope.username);
                  loginQuery.find('#passwordPassword').val($scope.userpwd);
                  
                  // Do Login submit.
                  urls['userLogin'] = ['POST' , 'https://library.rail-e.or.jp/e-library/Login'];
                  var personID = loginQuery.find('#textPersonId').val();
                  var password = loginQuery.find('#passwordPassword').val();
                  
                  loginQuery.find('#textPersonId_hid').val(getEncodeElementValue(personID));
                  loginQuery.find('#passwordPassword_hid').val(getEncodeElementValue(password));
                  loginQuery.find('input[name=act]').val('input');
                  
                   var params = { 'act' : 'login',
                                'textPersonId' : personID, 'passwordPassword' : password,
                                'textPersonId_hid' : getEncodeElementValue(personID),
                                'passwordPassword_hid' : getEncodeElementValue(password)
                               };
                
                  httpRequestService.getHtml('userLogin', params, makeFiledList(data));
                  
                  $scope.app.slidingMenu.setMainPage('page1.html');
                });
              });
              
              // make main page test list.
              // @params data return html data
              function makeFieldList(data){
                
              }
            }
          }]);
    </script>
</head>
<body>
    <ons-sliding-menu var="app.slidingMenu" menu-page="menu.html" main-page="toppage.html" side="left" type="overlay" max-slide-distance="200px">
    </ons-sliding-menu>
</body>
</html>
